#Loading and packages 

bankruptcy <- read.csv("[path]/data.csv") #read in the file
library(tidyverse)
library(tree)
library(rpart)
library(rpart.plot)
library(MASS)

#tree model: 

indBank =sample(1:nrow(bankruptcy), replace = FALSE, nrow(bankruptcy)*0.7)
bank_trn <- bankruptcy[indBank,]
bank_test <- bankruptcy[-indBank,]
banks_tree = rpart(Bankrupt. ~ ., data = bank_trn, method = "class")
summary(banks_tree)
rpart.plot(banks_tree)  #initial tree model 
pred_bank_initial <- predict(banks_tree, bank_test, type = "class")
table(predicted = pred_bank_initial,actual= bank_test$Bankrupt.)
(accuracy.full= mean(pred_bank_initial == bank_test$Bankrupt.)) #96.6 % accuracy predicting bankruptcy in the tree model!

### Full model code 

mod_bank <- glm(Bankrupt. ~ ., data = bankruptcy, family = binomial) #logistic regression with all vars
summary(mod_bank) # wow, they're all super significant! AIC: 16332

mod_back <- step(mod_bank, direction = "backward", trace = 0) #step process with backwards deletion 
summary(mod_back) #AIC: 25847

mod_forward <- step(mod_bank, direction = "forward", trace = 0) #step process with forwards adding 
summary(mod_forward) #AIC: 16332


### Profitability 


profitability <- bankruptcy %>% #new dataframe with selected columns based on profitability
  dplyr::select(Bankrupt., Operating.Gross.Margin, Realized.Sales.Gross.Margin, Pre.tax.net.Interest.Rate, 
  Operating.Profit.Growth.Rate, Cash.Flow.to.Equity, Total.income.Total.expense) # 

mod_profit <- glm(Bankrupt. ~., data = profitability, family = binomial)
summary(mod_profit) #only 2 significant predictors at alpha = 0.05. AIC: 1608.2

mod_back_prof <- step(mod_profit, direction = "backward", trace = 0) #step process with backwards deletion 
summary(mod_back_prof) # 3 predictors significant at alpha = 0.05 after backwards step process (intercept, realized.sales.gross.margin, total.income.total.expenses, cash.flow.to.equity is almost significant, 
#something to consider (pr>[z] = 0.0546), AIC: 1603.1
mod_forward_prof <- step(mod_profit, direction = "forward", trace = 0) #step process with forwards adding 
summary(mod_forward_prof) #only 2 predictors significant after forwards step process (cash.flow.to.equity, total.income.total.expenses), AIC: 1608.2

prof_no_outliers <- profitability %>%
  filter(hatvalues(mod_profit) < 0.05) #removed outliers based on hat values being larger than 0.05

mod_prof_no_outliers <- glm(Bankrupt. ~., data = prof_no_outliers, family = binomial)
summary(mod_prof_no_outliers) #4: intercept, operating.profit.growth.rate, cash.flow.to.equity, total.income.total.expense, AIC: 1580.7

mod_back_prof <- step(mod_prof_no_outliers, direction = "backward", trace = 0) #step process with backwards deletion 
summary(mod_back_prof) #4/4 predictors significant (Intercept, operating.profit.growth.rate, cash.flow.to.equity, total.income.total.expense), AIC: 1579.2

mod_forward_prof <- step(mod_prof_no_outliers, direction = "forward", trace = 0) #step process with forwards adding 
summary(mod_forward_prof) #4/7 significant predictors (intercept, operating.profit.growth.rate, cash.flow.to.equity.total.income.total.expense), AIC: 1580.7

### Growth Rates 


growth_rates <- bankruptcy %>% 
  dplyr::select(Bankrupt., contains("growth")) #growth rate category dataframe

mod_growth <- glm(Bankrupt. ~., data = growth_rates, family = binomial)
summary(mod_growth) #3 significant predictors at alpha = 0.05. AIC: 1916.1 (operating.profit.growth.rate, total.asset.growth.rate, total.asset.return.growth.rate.ratio)

growth_back <- step(mod_growth, direction = "backward", trace = 0) #step process with backwards deletion 
summary(growth_back) #4: operating.profit.growth.rate, after.tax.net.profit.growth.rate, total.asset.growth.rate, total.asset.return.growth.rate.ratio, AIC: 1911.2
growth_forward <- step(mod_growth, direction = "forward", trace = 0) #step process with forwards adding 
summary(growth_forward) # 3: operating.profit.growth.rate, total.asset.growth.rate, total.asset.return.growth.rate.ratio, AIC: 1916.1

growth_no_outliers <- growth_rates %>%
  filter(hatvalues(mod_growth) < 0.05) #removed outliers based on hat values being larger than 0.05

mod_growth_no_outliers <- glm(Bankrupt. ~., data = growth_no_outliers, family = binomial)
summary(mod_growth_no_outliers) #3/9 significant predictors (after.tax.net.profit.growth.rate, regular.net.profit.growth.rate, net.value.growth.rate, 
#continuous.net.profit.growth.rate is almost significant), AIC: 1505.7

mod_back_growth <- step(mod_growth_no_outliers, direction = "backward", trace = 0) #step process with backwards deletion 
summary(mod_back_growth) #4/6 high significance (Intercept,After.tax.Net.Profit.Growth.Rate,Regular.Net.Profit.Growth.Rate , Net.Value.Growth.Rate), 
#2/6 significant at 0.1 (Continuous.Net.Profit.Growth.Rate, Total.Asset.Growth.Rate), AIC: 1501.9

mod_back_growth <- step(mod_growth_no_outliers, direction = "forward", trace = 0) #step process with forwards adding 
summary(mod_back_growth) #3/9 significant predictors (After.tax.Net.Profit.Growth.Rate , Regular.Net.Profit.Growth.Rate, Net.Value.Growth.Rate), 
#1/9 significant at 0.1 (Continuous.Net.Profit.Growth.Rate), AIC: 1505.7


### Liquidity 

liquidity<- bankruptcy%>%select(Bankrupt.,Current.Ratio,Quick.Ratio,Cash.Flow.to.Total.Assets,Cash.Current.Liability,Working.Capital.to.Total.Assets,Long.term.fund.suitability.ratio..A.,Quick.Assets.Total.Assets)

mod_liquid<-glm(Bankrupt.~.,data=liquidity,family=binomial)
summary(mod_liquid)

#multicollinearity
library(regclass)
VIF(mod_liquid)
mod_less<-glm(Bankrupt.~.-Quick.Assets.Total.Assets,liquidity,family=binomial)
VIF(mod_less)
naive_liquid<-glm(bankrupt.~1,data=liq_outliers,family=binomial)

plot(mod_liquid,1)
plot(mod_liquid,2)
#a warning popped up that said not plotting observations with leverage one:2500

mod_back<-step(mod_liquid, direction="backward",trace=0)
summary(mod_back)
#start AIC=1672.9
#removed current.ratio since, without this variable AIC went down to 1671.1 (so 6 variables total)
#null deviance 1943.7, residual deviance 1657.1, AIC 1671.1

mod_forward<-step(mod_liquid,direction="forward",trace=0)
summary(mod_forward)
#the AIC for full model is 1673
#forward selection implied that all the variable should be included in the model, 
however, there were a lot of variables close to zero which are likely not statistically 
significant but yet, the forward model implies that none should be removed (all 7 kept)

#therefore, the backward selection is more optimal given that it lead to a better AIC score of 1672.9
mod_best_liquid<-step(mod_liquid,direction="both",trace=0)
summary(mod_best_liquid)

##removed outliers and did forward and backward selection again
no_liq_outliers<-liquidity%>%filter(hatvalues(mod_liquid)<0.05)
mod_no_outliers_liq<-glm(Bankrupt.~.,no_liq_outliers,family=binomial())
summary(mod_no_outliers_liq)

mod_back_liq<-step(mod_no_outliers_liq,direction="backward",trace=0)
summary(mod_back_liq)
#intercept, cash.flow.to.total.assets, cash.current.libaility,working.capital.to.total.assets,quick.assets.total.assets 
(not included: current.ratio,quick.ratio,Long.term.fund.suitability.ratio..A.)
#AIC: 1630.4

mod_forward_liq<-step(mod_no_outliers_liq,direction="forward",trace=0)
summary(mod_forward_liq)
#not statistically significant: Current.Ratio, Quick.Ratio, Long.term.fund.suitability.ratio..A.
#AIC: 1634
#Null deviance: 1914.9 (df:6794), Residual deviance: 1618.0 (df:6787)

mod<-glm(Bankrupt.~ . -Current.Ratio-Quick.Ratio-Long.term.fund.suitability.ratio..A.,no_liq_outliers,family=binomial)

chi2<-summary(mod)$null-summary(mod)$deviance
chi2
#chi2=2294.4852
p<-pchisq(chi2,df=4,lower.tail=FALSE)
p
#p=1.67619e-62
#We reject the null at a significant level of 0.05 for a logistic regression model 
predicting the probability of bankruptcy by 
the intercept, cash.flow.to.total.assets, cash.current.libaility,
working.capital.to.total.assets,quick.assets.total.assets is statistically significant.

library(ROCR)
pred<-predict(mod_back,type="response")
rocpred<-prediction(pred,liquidity$Bankrupt.)
roc<-performance(rocpred,"tpr","fpr")
plot(roc)
#area under the curve
auc<-performance(rocpred,measure="auc")
auc@y.values
#mod_back=0.8014513

pred_mod<-predict(mod,type="response")
rocpred<-prediction(pred_mod,no_liq_outliers$Bankrupt.)
roc<-performance(rocpred,"tpr","fpr")
plot(roc)
auc<-performance(rocpred,measure="auc")
auc@y.values
#mod=0.805652

##There is a small difference between mod_back (backward selection model)
and the model without outliers and non-significane values (that backward/forward selection
"said" to remove which we can maybe do a hypothesis test of???

## Following code added by Maddie for leverage model
## I used an R markdown file so that's why the formatting is a bit strange

Initializing new data frames and full models:
```{r}
bankruptcy <- read.csv("~/FALL 2025/STAT 308 F25/Final Project/bankruptcy.csv") #read in the file

mod_bank <- lm(Bankrupt. ~ ., data = bankruptcy) #simple linear regression with all variables
anova(mod_bank)

library(tidyverse)
leverage <- bankruptcy %>%
  select(Bankrupt., Borrowing.dependency, Contingent.liabilities.Net.worth, Debt.ratio.., Operating.Funds.to.Liability, Interest.bearing.debt.interest.rate, Total.debt.Total.net.worth, Liability.to.Equity, Liability.Assets.Flag, Degree.of.Financial.Leverage..DFL., Equity.to.Liability, Quick.Assets.Current.Liability)

leverage_model <- glm(Bankrupt. ~ ., leverage, family=binomial)
```

Performing backwards, forwards, and both variable selection strategy.
```{r}
model_back <- step(leverage_model, direction="backward", trace=0)
# backward strategy kept 7 variables; final AIC:1528
model_forward <- step(leverage_model, direction="forward", trace=0)
# forward strategy kept all variables; final AIC:1534
model_both <- step(leverage_model, direction="both", trace=0)
```

Found variables with high VIF (potential collinearity issue).
Removed Liability to Equity, which had a VIF = 37.803.
```{r}
library(car)
vif(leverage_model)

## Remove these high VIF variables from the model; ANOVA to see if new model is more statistically significant 
reduced_model <- glm(Bankrupt. ~ . -Liability.to.Equity, data=leverage, family=binomial)
# p-value = 0.000278; model excluding Liability to Equity variable better at predicting bankruptcy

# Hypothesis test using chi-squared and using exclusionary model from above
chi2 <- summary(reduced_model)$null - summary(reduced_model)$deviance
p <- pchisq(chi2, df=9, lower.tail=FALSE)
# p-value is extremely small, 3.5x10^-85
```

Filter out observations from original model with high hat values to rid of outliers.
```{r}
leverage_no_outliers <- leverage %>%
  filter(hatvalues(leverage_model) < 0.05)

naive_model <- glm(Bankrupt. ~ 1, data=leverage_no_outliers, family=binomial)

new_model_lev <- glm(Bankrupt. ~ ., data=leverage_no_outliers, family=binomial)

new_model_both <- step(new_model_lev, direction="both", trace=0)
# AIC:1464

```

Recalculate VIFs to check for collinearity.

```{r}
vif(new_model_both)
# VIF for Liability to Equity = 10.465

# New model removing this variable:
new_model <- glm(Bankrupt. ~ Debt.ratio.. + Operating.Funds.to.Liability + Total.debt.Total.net.worth + Liability.Assets.Flag + Equity.to.Liability + Quick.Assets.Current.Liability, leverage_no_outliers, family=binomial)

# Check VIFs again.
vif(new_model)
# Total debt/Total net worth VIF moderately high.

anova(new_model, new_model_both)
# model without liability/equity -> p-value=4.69e-5, indicating that it is more statistically 
# significant in predicting Bankruptcy than the model including liability/equity

# Try the same thing removing total debt/total net worth
new_model2 <- glm(Bankrupt. ~ Debt.ratio.. + Operating.Funds.to.Liability + Liability.Assets.Flag + Equity.to.Liability + Quick.Assets.Current.Liability, leverage_no_outliers, family=binomial)

anova(new_model, new_model2)
# p-value=2.068e-4; model is more statistically significant when removing both values with high VIFs

vif(new_model2)
# All VIFs are now less than 2
```

Chi-square hypothesis test to test signficance of this model in predicting bankruptcy.
```{r}
chi_sq <- summary(new_model2)$null - summary(new_model2)$deviance
p <- pchisq(chi2, df=4, lower.tail=FALSE)
# p-value = 1.742x10^-89
```

# FULL MODEL 

full_model2 <- glm(Bankrupt. ~ Total.income.Total.expense + Cash.Flow.to.Equity + Operating.Profit.Growth.Rate + Cash.Flow.to.Total.Assets + Cash.Current.Liability + Working.Capital.to.Total.Assets + Quick.Assets.Total.Assets + Debt.ratio.. + Operating.Funds.to.Liability +
                    Liability.Assets.Flag + Equity.to.Liability + Quick.Assets.Current.Liability + 
                    Net.Value.Growth.Rate + Continuous.Net.Profit.Growth.Rate, bankruptcy, family = binomial)
summary(full_model2)

full_model3 <- bankruptcy %>%
  filter(hatvalues(full_model2) < 0.05) #removed outliers based on hat values being larger than 0.05



####ROC CODE AND AUC CODE
#install ROCR package

library(ROCR)
pred<-predict(model,type="response")
rocpred<-prediction(pred,datafram$Bankrupt.)
roc<-performance(rocpred,"tpr","fpr")
plot(roc)

#area under the curve
auc<-performance(rocpred,measure="auc")
auc@y.values

## LEVERAGE

leverage <- bankruptcy %>%
  select(Bankrupt., Borrowing.dependency, Contingent.liabilities.Net.worth, Debt.ratio.., Operating.Funds.to.Liability, Interest.bearing.debt.interest.rate, Total.debt.Total.net.worth, Liability.to.Equity, Liability.Assets.Flag, Degree.of.Financial.Leverage..DFL., Equity.to.Liability, Quick.Assets.Current.Liability)

leverage_model <- glm(Bankrupt. ~ ., leverage, family=binomial)

leverage_no_outliers <- leverage %>%
  filter(hatvalues(leverage_model) < 0.05)

final_df <- bankruptcy %>%
  select(Borrowing.dependency, Debt.ratio.., Operating.Funds.to.Liability, Total.debt.Total.net.worth, Equity.to.Liability, Quick.Assets.Current.Liability, Bankrupt.)

updated_model <- glm(Bankrupt. ~ Borrowing.dependency + Debt.ratio.. + Operating.Funds.to.Liability + Total.debt.Total.net.worth + Equity.to.Liability + Quick.Assets.Current.Liability, leverage_no_outliers, family=binomial)
